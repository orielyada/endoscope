import usb_hid
import usb_cdc
import supervisor

# Expose custom product/manufacturer strings for host-side identification.
supervisor.set_usb_identification(
    manufacturer="OriElyada",
    product="Endoscope",
)

# Keep CDC console/data enabled for serial debug and control.
usb_cdc.enable(console=True, data=True)

# Composite HID descriptor (single interface, two joystick application collections):
# - Joystick #1: INPUT Report ID 1 (16-byte payload) + OUTPUT Report ID 3 control
# - Joystick #2: INPUT Report ID 2 (10-byte payload, quaternion on X/Y/Z/Rz)
REPORT_DESC = bytes((
    0x05, 0x01,
    0x09, 0x04,
    0xA1, 0x01,

    0x85, 0x01,
    0x06, 0x00, 0xFF,
    0x09, 0x20,
    0x15, 0x00,
    0x26, 0xFF, 0x00,
    0x75, 0x08,
    0x95, 0x01,
    0x81, 0x02,

    0x05, 0x09,
    0x19, 0x01,
    0x29, 0x18,
    0x15, 0x00,
    0x25, 0x01,
    0x75, 0x01,
    0x95, 0x18,
    0x81, 0x02,

    0x05, 0x01,
    0x09, 0x30,
    0x09, 0x31,
    0x09, 0x32,
    0x09, 0x35,
    0x09, 0x36,
    0x09, 0x38,
    0x16, 0x00, 0x80,
    0x26, 0xFF, 0x7F,
    0x75, 0x10,
    0x95, 0x06,
    0x81, 0x02,

    0x85, 0x03,
    0x06, 0x00, 0xFF,
    0x09, 0x30,
    0x15, 0x00,
    0x26, 0xFF, 0x00,
    0x75, 0x08,
    0x95, 0x04,
    0x91, 0x02,

    0xC0,

    0x05, 0x01,
    0x09, 0x04,
    0xA1, 0x01,

    0x85, 0x02,
    0x06, 0x00, 0xFF,
    0x09, 0x21,
    0x15, 0x00,
    0x25, 0xFF,
    0x75, 0x08,
    0x95, 0x01,
    0x81, 0x02,

    0x05, 0x09,
    0x19, 0x01,
    0x29, 0x08,
    0x15, 0x00,
    0x25, 0x01,
    0x75, 0x01,
    0x95, 0x08,
    0x81, 0x02,

    0x05, 0x01,
    0x09, 0x30,
    0x09, 0x31,
    0x09, 0x32,
    0x09, 0x35,
    0x16, 0x00, 0xC0,
    0x26, 0x00, 0x40,
    0x75, 0x10,
    0x95, 0x04,
    0x81, 0x02,

    0xC0,
))

# Single HID interface exposing two joystick collections and one control output report.
endoscope_hid = usb_hid.Device(
    report_descriptor=REPORT_DESC,
    usage_page=0x01,
    usage=0x0004,
    report_ids=(1, 2, 3),
    in_report_lengths=(16, 10, 0),
    out_report_lengths=(0, 0, 4),
)

# Enable only this HID device at boot.
usb_hid.enable((endoscope_hid,), boot_device=False)
